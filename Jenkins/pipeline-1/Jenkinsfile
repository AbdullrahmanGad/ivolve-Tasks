pipeline {
    agent any
    
    tools {
        maven 'Mvn3.9'  
        jdk 'JDK-17'       
    }
    
    environment {
        // Docker Hub credentials
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
        DOCKERHUB_USERNAME = 'abdelrahmangad275'  // ‚ö†Ô∏è CHANGE THIS!
        
        // Image details
        IMAGE_NAME = 'jenkins-app'
        IMAGE_TAG = "${BUILD_NUMBER}"
        FULL_IMAGE_NAME = "${DOCKERHUB_USERNAME}/${IMAGE_NAME}:${IMAGE_TAG}"
        
        // GitHub repo
        GIT_REPO = 'https://github.com/AbdullrahmanGad/ivolve-Tasks.git'
        GIT_BRANCH = 'main'
        
        // Project directory
        PROJECT_DIR = 'Jenkins/pipeline-1'
    }
    
    stages {
        stage('Clone Repository') {
            steps {
                echo 'üì• Cloning repository from GitHub...'
                git branch: "${GIT_BRANCH}", 
                    url: "${GIT_REPO}"
                
                echo 'Repository cloned successfully!'
                sh '''
                    echo "Root directory contents:"
                    ls -la
                    echo "---"
                    echo "Project directory contents:"
                    ls -la Jenkins/pipeline-1/
                '''
            }
        }
        
        stage('Environment Info') {
            steps {
                echo 'üîç Checking build environment...'
                dir("${PROJECT_DIR}") {
                    sh '''
                        echo "Java Version:"
                        java -version
                        echo "---"
                        echo "Maven Version:"
                        mvn -version
                        echo "---"
                        echo "Current Directory:"
                        pwd
                        echo "---"
                        echo "Project Files:"
                        ls -la
                    '''
                }
            }
        }
        
        stage('Run Unit Tests') {
            steps {
                echo 'üß™ Running unit tests...'
                dir("${PROJECT_DIR}") {
                    script {
                        try {
                            sh 'mvn clean test'
                            echo '‚úÖ All tests passed!'
                        } catch (Exception e) {
                            echo '‚ö†Ô∏è Some tests failed, but continuing...'
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                }
            }
            post {
                always {
                    dir("${PROJECT_DIR}") {
                        junit allowEmptyResults: true, testResults: '**/target/surefire-reports/*.xml'
                    }
                }
            }
        }
        
        stage('Build Application') {
            steps {
                echo 'üî® Building Java application with Maven...'
                dir("${PROJECT_DIR}") {
                    sh '''
                        mvn clean package -DskipTests
                        echo "---"
                        echo "Build artifacts:"
                        ls -lh target/*.jar
                    '''
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo "üê≥ Building Docker image: ${FULL_IMAGE_NAME}"
                dir("${PROJECT_DIR}") {
                    sh '''
                        echo "Files in project directory:"
                        ls -la
                        echo "---"
                        echo "JAR files in target:"
                        ls -la target/*.jar
                    '''
                    
                    sh """
                        docker build -t ${FULL_IMAGE_NAME} .
                        echo "‚úÖ Docker image built successfully!"
                        docker images | grep ${IMAGE_NAME}
                    """
                }
            }
        }
        
        stage('Push to Docker Hub') {
            steps {
                echo 'üì§ Pushing image to Docker Hub...'
                script {
                    sh """
                        echo \$DOCKERHUB_CREDENTIALS_PSW | docker login -u \$DOCKERHUB_CREDENTIALS_USR --password-stdin
                        docker push ${FULL_IMAGE_NAME}
                        echo "‚úÖ Image pushed: ${FULL_IMAGE_NAME}"
                    """
                }
            }
        }
        
        stage('Delete Local Image') {
            steps {
                echo 'üßπ Cleaning up local Docker image...'
                script {
                    sh """
                        docker rmi ${FULL_IMAGE_NAME} || true
                        docker logout
                        echo "‚úÖ Local cleanup complete"
                    """
                }
            }
        }
        
        stage('Update Deployment YAML') {
            steps {
                echo 'üìù Updating deployment.yaml with new image...'
                dir("${PROJECT_DIR}") {
                    sh """
                        if [ -f deployment.yaml ]; then
                            echo "Found deployment.yaml"
                            cp deployment.yaml deployment.yaml.bak
                            sed -i 's|image:.*${IMAGE_NAME}.*|image: ${FULL_IMAGE_NAME}|g' deployment.yaml
                            echo "Updated image in deployment.yaml:"
                            grep "image:" deployment.yaml
                        else
                            echo "‚ùå deployment.yaml not found!"
                            exit 1
                        fi
                    """
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                echo '‚ò∏Ô∏è  Deploying to Kubernetes cluster...'
                dir("${PROJECT_DIR}") {
                    withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {
                        sh """
                            kubectl --kubeconfig=\$KUBECONFIG apply -f deployment.yaml
                            kubectl --kubeconfig=\$KUBECONFIG rollout status deployment/jenkins-app -n default --timeout=5m
                            
                            echo "üìä Deployment Status:"
                            kubectl --kubeconfig=\$KUBECONFIG get deployment jenkins-app -n default
                            
                            echo "üì¶ Pods:"
                            kubectl --kubeconfig=\$KUBECONFIG get pods -l app=jenkins-app -n default
                            
                            echo "üåê Service:"
                            kubectl --kubeconfig=\$KUBECONFIG get svc jenkins-app-service -n default
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo '=' * 50
            echo 'üìä Pipeline Execution Summary'
            echo '=' * 50
            echo "Job: ${env.JOB_NAME}"
            echo "Build: #${env.BUILD_NUMBER}"
            echo "Status: ${currentBuild.result ?: 'SUCCESS'}"
            echo "Duration: ${currentBuild.durationString}"
            echo "Image: ${FULL_IMAGE_NAME}"
            echo '=' * 50
            
            dir("${PROJECT_DIR}") {
                archiveArtifacts artifacts: 'target/*.jar', allowEmptyArchive: true
            }
            
            cleanWs()
        }
        
        success {
            echo '‚úÖ SUCCESS: Pipeline completed!'
            echo "üöÄ Deployed: ${FULL_IMAGE_NAME}"
        }
        
        failure {
            echo '‚ùå FAILURE: Pipeline failed!'
            echo 'üìã Check console output for details'
        }
        
        unstable {
            echo '‚ö†Ô∏è  UNSTABLE: Some tests failed'
        }
    }
}
